description: |-
  #advanced-tutorial
  Indexing and retrieval augmented generation (RAG) using a vector database (Qdrant via MCP). Showcases Iterative Subgraphs with list values.

  On the first run, it will chunk a source text and add it to the index.

  Subsequent runs will  retrieve context from the index and pass it to the chat model.

  There are many ways you may want to extend this:

  - Generate the query from the prompt using an LLM instead of using the prompt directly
  - Use an LLM to evaluate if the retrieval is relevant to the prompt and branch the workflow
  - Use an LLM to score each individual retrieval and use the best one (reranking)
  - Use an LLM to validate that the response is grounded within the context instead of hallicinated
  - Recursive chunking as a rhai script, custom node or standalone MCP server tool
  - Create an MCP server that supports deduplication and reranking models
chain:
- rag-qdrant
uuid: 93d431c1-e21b-47fe-8e23-b7f4fb54646b
nodes:
  0:
    value:
      Start: {}
    pos:
      x: -474.04282
      y: -1474.3953
    open: true
  1:
    value:
      Finish: {}
    pos:
      x: 1887.218
      y: -962.04443
    open: true
  2:
    value:
      ParseJson:
        text: '{}'
        extract: true
        size:
          x: 168.0
          y: 66.09375
    pos:
      x: 1309.1783
      y: 751.6078
    open: true
  3:
    value:
      Tools:
        toolset:
        - chainer/rag-qdrant
        size:
          x: 250.0
          y: 250.0
    pos:
      x: 1697.893
      y: -277.77335
    open: true
  4:
    value:
      Subgraph:
        title: Index context
        flavor: Iterative
        graph:
          uuid: c39ba4eb-5145-49cd-aa42-b060af4d55e1
          nodes:
            0:
              value:
                Start:
                  fields:
                  - - collection
                    - Text
                  - - text
                    - Text
              pos:
                x: -105.65347
                y: -188.13844
              open: true
            1:
              value:
                Finish:
                  fields:
                  - - text
                    - Text
              pos:
                x: 1924.9948
                y: -165.63559
              open: true
            2:
              value:
                RhaiNode:
                  script: print(input)
                  inputs:
                  - - input
                    - Text
                  outputs:
                  - - output
                    - Text
                  size:
                    x: 300.0
                    y: 150.0
              pos:
                x: 364.12808
                y: 324.6587
              open: true
            3:
              value:
                Tools:
                  toolset:
                  - qdrant-local/qdrant-store
                  size:
                    x: 250.0
                    y: 250.0
              pos:
                x: 909.29114
                y: -776.10657
              open: true
            4:
              value:
                TransformJson:
                  filter: |-
                    {
                      "collection_name":  .[0],
                      "information": .[1]
                    }
                  size:
                    x: 300.0
                    y: 150.0
              pos:
                x: 756.4009
                y: -276.87054
              open: true
            5:
              value:
                InvokeTool:
                  tool_name: ''
              pos:
                x: 1380.6583
                y: -351.77063
              open: true
            6:
              value:
                GatherJson:
                  count: 2
              pos:
                x: 246.04607
                y: -260.7539
              open: true
          wires:
          - out_pin:
              node: 0
              output: 0
            in_pin:
              node: 6
              input: 0
          - out_pin:
              node: 0
              output: 1
            in_pin:
              node: 2
              input: 0
          - out_pin:
              node: 0
              output: 1
            in_pin:
              node: 6
              input: 1
          - out_pin:
              node: 3
              output: 0
            in_pin:
              node: 5
              input: 1
          - out_pin:
              node: 4
              output: 0
            in_pin:
              node: 5
              input: 3
          - out_pin:
              node: 5
              output: 2
            in_pin:
              node: 1
              input: 0
          - out_pin:
              node: 6
              output: 0
            in_pin:
              node: 4
              input: 1
          disabled:
          - 2
          start: 0
          finish: 1
    pos:
      x: 1294.5316
      y: 309.82437
    open: true
  5:
    value:
      InvokeTool:
        tool_name: ''
    pos:
      x: 2229.882
      y: 271.96872
    open: true
  6:
    value:
      Subgraph:
        title: Lookup context
        graph:
          uuid: 481926f3-bad7-430b-a875-2959b690437e
          nodes:
            0:
              value:
                Start:
                  fields:
                  - - query
                    - Text
                  - - collection
                    - Text
              pos:
                x: 51.345173
                y: 23.274223
              open: true
            1:
              value:
                Finish:
                  fields:
                  - - output
                    - Text
              pos:
                x: 3875.726
                y: -80.09473
              open: true
            2:
              value:
                Tools:
                  toolset:
                  - qdrant-local/qdrant-find
                  size:
                    x: 250.0
                    y: 250.0
              pos:
                x: 863.12
                y: -499.8619
              open: true
            3:
              value:
                InvokeTool:
                  tool_name: ''
              pos:
                x: 1260.076
                y: -27.464418
              open: true
            4:
              value:
                ParseJson:
                  text: ''
                  extract: true
                  as_array: true
                  size:
                    x: 300.0
                    y: 306.5
              pos:
                x: 1681.5187
                y: 86.024216
              open: true
            5:
              value:
                GatherJson:
                  count: 2
              pos:
                x: 405.48715
                y: 26.101515
              open: true
            6:
              value:
                TransformJson:
                  filter: |-
                    {
                      "query": .[0],
                      "collection_name": .[1]
                    }
                  size:
                    x: 300.0
                    y: 150.0
              pos:
                x: 767.366
                y: 0.8934543
              open: true
            7:
              value:
                TransformJson:
                  filter: .[1]
                  size:
                    x: 300.0
                    y: 150.0
              pos:
                x: 2120.7356
                y: 39.902157
              open: true
            8:
              value:
                Preview:
                  size:
                    x: 582.71875
                    y: 356.53125
                  uuid: 0305d5db-ac4d-4873-a0b0-7224d2eec3a3
              pos:
                x: 3813.6133
                y: 542.6436
              open: true
            9:
              value:
                Fallback:
                  kinds:
                  - Text
              pos:
                x: 2113.607
                y: 640.332
              open: true
            10:
              value:
                GatherJson:
                  count: 1
              pos:
                x: 2450.8203
                y: 658.56104
              open: true
            11:
              value:
                Select:
                  count: 2
                  kind: Json
              pos:
                x: 2829.461
                y: 351.561
              open: true
            12:
              value:
                UnwrapJson:
                  kind: Text
              pos:
                x: 3172.5454
                y: 226.98491
              open: true
            13:
              value:
                CommentNode:
                  comment: |-
                    Returns an array of strings. First element is the query itself.
                    Remaining elements are documents wrapped in XML tags.
                  size:
                    x: 365.375
                    y: 315.46875
              pos:
                x: 1259.0765
                y: 427.92255
              open: true
            14:
              value:
                CommentNode:
                  comment: We could use a regex filter to strip the XML tags, but they're harmless, so we'll leave them alone.
                  size:
                    x: 324.0
                    y: 158.53125
              pos:
                x: 2121.3547
                y: -280.42136
              open: true
          wires:
          - out_pin:
              node: 0
              output: 0
            in_pin:
              node: 5
              input: 0
          - out_pin:
              node: 0
              output: 1
            in_pin:
              node: 5
              input: 1
          - out_pin:
              node: 2
              output: 0
            in_pin:
              node: 3
              input: 1
          - out_pin:
              node: 3
              output: 2
            in_pin:
              node: 4
              input: 0
          - out_pin:
              node: 3
              output: 2
            in_pin:
              node: 9
              input: 1
          - out_pin:
              node: 4
              output: 0
            in_pin:
              node: 7
              input: 1
          - out_pin:
              node: 4
              output: 1
            in_pin:
              node: 9
              input: 0
          - out_pin:
              node: 5
              output: 0
            in_pin:
              node: 6
              input: 1
          - out_pin:
              node: 6
              output: 0
            in_pin:
              node: 3
              input: 3
          - out_pin:
              node: 7
              output: 0
            in_pin:
              node: 11
              input: 0
          - out_pin:
              node: 9
              output: 0
            in_pin:
              node: 10
              input: 0
          - out_pin:
              node: 10
              output: 0
            in_pin:
              node: 11
              input: 1
          - out_pin:
              node: 11
              output: 0
            in_pin:
              node: 12
              input: 0
          - out_pin:
              node: 12
              output: 0
            in_pin:
              node: 1
              input: 0
          - out_pin:
              node: 12
              output: 0
            in_pin:
              node: 8
              input: 0
          start: 0
          finish: 1
    pos:
      x: 418.11172
      y: -866.2053
    open: true
  7:
    value:
      Preview:
        size:
          x: 728.0625
          y: 438.0
        uuid: 860e8a6a-479a-4567-9ddd-3caa2aeeb8ea
    pos:
      x: 2285.422
      y: -814.41925
    open: true
  8:
    value:
      Text:
        value: rust-book
        size:
          x: 308.0
          y: 150.0
    pos:
      x: -175.63843
      y: -667.9529
    open: true
  9:
    value:
      CommentNode:
        comment: |-
          Save this to a file named `qdrant-local.mcp` and import it in the tools tab:

          ```
          type: Stdio
          enabled: true
          env: |-
            EMBEDDING_MODEL=BAAI/bge-small-en-v1.5
            FASTEMBED_CACHE_PATH=$HOME/.local/share/fastembed/cache
            QDRANT_LOCAL_PATH=/tmp/aerie/data
          command: nix-shell
          args:
          - '-p'
          - uv
          - '--run'
          - uvx mcp-server-qdrant
          timeout: 30
          ```
        size:
          x: 844.625
          y: 575.40625
    pos:
      x: -1181.2616
      y: -1082.4242
    open: true
  10:
    value:
      Fallback:
        kinds:
        - Text
    pos:
      x: 950.9571
      y: -515.6218
    open: true
  11:
    value:
      ChatNode:
        prompt: ''
        size:
          x: 300.0
          y: 150.0
    pos:
      x: 1430.4631
      y: -1067.973
    open: true
  12:
    value:
      Text:
        value: |-
          The Rust programming language has come a long way in a few short years, from its creation and incubation by a small and nascent community of enthusiasts, to becoming one of the most loved and in-demand programming languages in the world. Looking back, it was inevitable that the power and promise of Rust would turn heads and gain a foothold in systems programming. What was not inevitable was the global growth in interest and innovation that permeated through open source communities and catalyzed wide-scale adoption across industries.

          At this point in time, it is easy to point to the wonderful features that Rust has to offer to explain this explosion in interest and adoption. Who doesn’t want memory safety, and fast performance, and a friendly compiler, and great tooling, among a host of other wonderful features? The Rust language you see today combines years of research in systems programming with the practical wisdom of a vibrant and passionate community. This language was designed with purpose and crafted with care, offering developers a tool that makes it easier to write safe, fast, and reliable code.

          But what makes Rust truly special is its roots in empowering you, the user, to achieve your goals. This is a language that wants you to succeed, and the principle of empowerment runs through the core of the community that builds, maintains, and advocates for this language. Since the previous edition of this definitive text, Rust has further developed into a truly global and trusted language. The Rust Project is now robustly supported by the Rust Foundation, which also invests in key initiatives to ensure that Rust is secure, stable, and sustainable.

          This edition of The Rust Programming Language is a comprehensive update, reflecting the language’s evolution over the years and providing valuable new information. But it is not just a guide to syntax and libraries—it’s an invitation to join a community that values quality, performance, and thoughtful design. Whether you’re a seasoned developer looking to explore Rust for the first time or an experienced Rustacean looking to refine your skills, this edition offers something for everyone.

          The Rust journey has been one of collaboration, learning, and iteration. The growth of the language and its ecosystem is a direct reflection of the vibrant, diverse community behind it. The contributions of thousands of developers, from core language designers to casual contributors, are what make Rust such a unique and powerful tool. By picking up this book, you’re not just learning a new programming language—you’re joining a movement to make software better, safer, and more enjoyable to work with.
        size:
          x: 453.0
          y: 330.125
    pos:
      x: 27.935385
      y: 185.93399
    open: true
  13:
    value:
      RhaiNode:
        script: input.split("\n\n")
        inputs:
        - - input
          - Text
        outputs:
        - - '[textlist]'
          - TextList
        size:
          x: 303.0
          y: 64.0
    pos:
      x: 737.2339
      y: 316.51675
    open: true
  14:
    value:
      GateNode:
        kind: Json
    pos:
      x: 1766.4492
      y: 540.1148
    open: true
  15:
    value:
      AgentNode: {}
    pos:
      x: 400.01163
      y: -1639.8242
    open: true
  16:
    value:
      ChatContext:
        context_doc: ''
        size:
          x: 300.0
          y: 150.0
    pos:
      x: 1008.76154
      y: -1253.4617
    open: true
  17:
    value:
      CommentNode:
        comment: 'From: https://doc.rust-lang.org/book/foreword.html'
        size:
          x: 300.0
          y: 150.0
    pos:
      x: 97.72559
      y: 812.2279
    open: true
  18:
    value:
      CommentNode:
        comment: This lower branch populates the database if it is empty then queues the workflow to run again.
        size:
          x: 300.0
          y: 150.0
    pos:
      x: -533.97174
      y: 379.59824
    open: true
  19:
    value:
      Subgraph:
        title: Prompt default
        graph:
          uuid: 05044a4e-82f8-421a-9757-d331fcacd737
          nodes:
            0:
              value:
                Start:
                  fields:
                  - - input
                    - Text
              pos:
                x: 0.0
                y: 0.0
              open: true
            1:
              value:
                Finish:
                  fields:
                  - - output
                    - Text
              pos:
                x: 2000.0
                y: 0.0
              open: true
            2:
              value:
                Text:
                  value: What makes rust special?
                  size:
                    x: 408.0
                    y: 150.0
              pos:
                x: 976.7326
                y: -226.23512
              open: true
            3:
              value:
                Matcher:
                  kind: Text
                  patterns:
                  - ''
                  exact: true
              pos:
                x: 526.74335
                y: -132.84224
              open: true
            4:
              value:
                Select:
                  count: 2
                  kind: Text
              pos:
                x: 1474.6001
                y: 120.77542
              open: true
          wires:
          - out_pin:
              node: 0
              output: 0
            in_pin:
              node: 3
              input: 0
          - out_pin:
              node: 0
              output: 0
            in_pin:
              node: 3
              input: 1
          - out_pin:
              node: 2
              output: 0
            in_pin:
              node: 4
              input: 0
          - out_pin:
              node: 3
              output: 0
            in_pin:
              node: 2
              input: 0
          - out_pin:
              node: 3
              output: 1
            in_pin:
              node: 4
              input: 1
          - out_pin:
              node: 4
              output: 0
            in_pin:
              node: 1
              input: 0
          start: 0
          finish: 1
    pos:
      x: -137.6311
      y: -1178.9121
    open: true
  20:
    value:
      Fallback:
        kinds:
        - Json
    pos:
      x: 1820.3164
      y: 819.1134
    open: true
wires:
- out_pin:
    node: 0
    output: 0
  in_pin:
    node: 15
    input: 1
- out_pin:
    node: 0
    output: 2
  in_pin:
    node: 11
    input: 1
- out_pin:
    node: 0
    output: 4
  in_pin:
    node: 19
    input: 0
- out_pin:
    node: 2
    output: 0
  in_pin:
    node: 14
    input: 1
- out_pin:
    node: 2
    output: 0
  in_pin:
    node: 20
    input: 1
- out_pin:
    node: 3
    output: 0
  in_pin:
    node: 5
    input: 1
- out_pin:
    node: 4
    output: 0
  in_pin:
    node: 14
    input: 0
- out_pin:
    node: 6
    output: 0
  in_pin:
    node: 7
    input: 0
- out_pin:
    node: 6
    output: 0
  in_pin:
    node: 16
    input: 1
- out_pin:
    node: 6
    output: 1
  in_pin:
    node: 10
    input: 0
- out_pin:
    node: 8
    output: 0
  in_pin:
    node: 6
    input: 1
- out_pin:
    node: 8
    output: 0
  in_pin:
    node: 10
    input: 1
- out_pin:
    node: 10
    output: 0
  in_pin:
    node: 4
    input: 0
- out_pin:
    node: 12
    output: 0
  in_pin:
    node: 13
    input: 0
- out_pin:
    node: 13
    output: 0
  in_pin:
    node: 4
    input: 1
- out_pin:
    node: 14
    output: 0
  in_pin:
    node: 5
    input: 3
- out_pin:
    node: 15
    output: 0
  in_pin:
    node: 16
    input: 0
- out_pin:
    node: 16
    output: 0
  in_pin:
    node: 11
    input: 0
- out_pin:
    node: 19
    output: 0
  in_pin:
    node: 6
    input: 0
- out_pin:
    node: 19
    output: 0
  in_pin:
    node: 11
    input: 2
disabled:
- 11
start: 0
finish: 1
